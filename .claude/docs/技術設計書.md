# ランダム散歩アプリ 技術設計書

## 1. システム概要

### 1.1 アーキテクチャ
- フロントエンド・バックエンド統合: Next.js v16 (App Router)
- データベース: Supabase (PostgreSQL)
- スタイリング: Tailwind CSS
- デプロイ: Vercel推奨

### 1.2 システム構成図
```
[ユーザー（スマートフォン/ブラウザ）]
            ↓
[Next.js App (Vercel)]
            ↓
[Supabase Database]
```

## 2. ディレクトリ構造

```
random-walk-app/
├── src/
│   ├── app/
│   │   ├── layout.tsx          # ルートレイアウト
│   │   ├── page.tsx            # メインページ
│   │   └── api/
│   │       └── random/
│   │           └── route.ts    # ランダム生成API
│   ├── components/
│   │   ├── RandomButton.tsx    # ランダム生成ボタン
│   │   ├── RouletteAnimation.tsx  # ルーレット演出
│   │   └── ResultDisplay.tsx   # 結果表示
│   ├── lib/
│   │   ├── supabase.ts         # Supabaseクライアント
│   │   └── types.ts            # 型定義
│   └── styles/
│       └── globals.css         # グローバルスタイル
├── public/
│   └── images/                 # 画像ファイル
├── .env.local                  # 環境変数
├── package.json
├── tsconfig.json
├── tailwind.config.js
└── next.config.js
```

## 3. データベース設計

### 3.1 テーブル構造

#### locationsテーブル（どこで）
| カラム名 | 型 | 制約 | 説明 |
|---------|-----|-----|------|
| id | uuid | PRIMARY KEY, DEFAULT uuid_generate_v4() | 一意識別子 |
| text | text | NOT NULL | 場所のテキスト |
| is_active | boolean | DEFAULT true | 有効/無効フラグ |
| created_at | timestamp | DEFAULT now() | 作成日時 |
| updated_at | timestamp | DEFAULT now() | 更新日時 |

#### actionsテーブル（なにをする）
| カラム名 | 型 | 制約 | 説明 |
|---------|-----|-----|------|
| id | uuid | PRIMARY KEY, DEFAULT uuid_generate_v4() | 一意識別子 |
| text | text | NOT NULL | 行動のテキスト |
| is_active | boolean | DEFAULT true | 有効/無効フラグ |
| created_at | timestamp | DEFAULT now() | 作成日時 |
| updated_at | timestamp | DEFAULT now() | 更新日時 |

### 3.2 SQLマイグレーション

```sql
-- locationsテーブル作成
CREATE TABLE locations (
  id uuid PRIMARY KEY DEFAULT uuid_generate_v4(),
  text text NOT NULL,
  is_active boolean DEFAULT true,
  created_at timestamp DEFAULT now(),
  updated_at timestamp DEFAULT now()
);

-- actionsテーブル作成
CREATE TABLE actions (
  id uuid PRIMARY KEY DEFAULT uuid_generate_v4(),
  text text NOT NULL,
  is_active boolean DEFAULT true,
  created_at timestamp DEFAULT now(),
  updated_at timestamp DEFAULT now()
);

-- インデックス作成
CREATE INDEX idx_locations_active ON locations(is_active);
CREATE INDEX idx_actions_active ON actions(is_active);

-- 更新日時の自動更新トリガー
CREATE OR REPLACE FUNCTION update_updated_at()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = now();
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER locations_updated_at
BEFORE UPDATE ON locations
FOR EACH ROW
EXECUTE FUNCTION update_updated_at();

CREATE TRIGGER actions_updated_at
BEFORE UPDATE ON actions
FOR EACH ROW
EXECUTE FUNCTION update_updated_at();
```

## 4. API設計

### 4.1 ランダム生成API

#### エンドポイント
```
GET /api/random
```

#### レスポンス
```json
{
  "location": {
    "id": "uuid",
    "text": "近くの公園で"
  },
  "action": {
    "id": "uuid",
    "text": "写真を撮る"
  }
}
```

#### エラーレスポンス
```json
{
  "error": "データの取得に失敗しました"
}
```

#### 実装ロジック
1. Supabaseから`is_active=true`の全locationsを取得
2. Supabaseから`is_active=true`の全actionsを取得
3. それぞれからランダムに1件選択
4. 組み合わせを返却

## 5. コンポーネント設計

### 5.1 コンポーネント一覧

#### RandomButton
- 役割: メインのランダム生成ボタン
- Props: `onClick: () => void`, `disabled: boolean`
- 状態: なし（親から制御）

#### RouletteAnimation
- 役割: ルーレット演出の表示
- Props: `isAnimating: boolean`, `duration: number`
- 状態: アニメーション中の表示テキスト

#### ResultDisplay
- 役割: 結果の表示と再生成ボタン
- Props: `location: string`, `action: string`, `onRegenerate: () => void`
- 状態: なし

### 5.2 ページ状態管理

メインページ（page.tsx）で以下の状態を管理:
```typescript
type AppState = 'idle' | 'animating' | 'result';

interface Result {
  location: string;
  action: string;
}

const [state, setState] = useState<AppState>('idle');
const [result, setResult] = useState<Result | null>(null);
```

## 6. 技術仕様詳細

### 6.1 ルーレット演出
- アニメーション時間: 2〜3秒
- 実装方法: CSSアニメーション + setInterval/setTimeout
- 演出内容: テキストが高速で切り替わる（約50ms間隔）

### 6.2 レスポンシブデザイン
- ブレークポイント:
  - モバイル: 〜640px
  - タブレット: 641px〜1024px
  - デスクトップ: 1025px〜

### 6.3 環境変数
```env
# .env.local
NEXT_PUBLIC_SUPABASE_URL=your_supabase_url
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_supabase_anon_key
```

## 7. セキュリティ要件

### 7.1 Supabase RLS（Row Level Security）
- 読み取り専用ポリシーを設定
- 認証なしで`locations`と`actions`の読み取りを許可
- 書き込みは管理者のみ（Supabase Dashboardから）

### 7.2 レート制限
- Vercelのデフォルトレート制限に依存
- 必要に応じてミドルウェアで追加制限

## 8. パフォーマンス要件

### 8.1 レスポンス時間
- API応答: 500ms以内
- ページ読み込み: 2秒以内（LCP）

### 8.2 最適化戦略
- Next.js App Routerのキャッシング活用
- Tailwind CSSのプロダクションビルドで未使用スタイル削除
- 画像最適化（next/image使用）

## 9. テスト戦略

### 9.1 テスト範囲
- APIエンドポイントの単体テスト
- コンポーネントのスナップショットテスト
- E2Eテスト（オプション）

### 9.2 推奨ツール
- Jest + React Testing Library
- Playwright（E2E）

## 10. デプロイ

### 10.1 本番環境
- ホスティング: Vercel
- データベース: Supabase（本番プロジェクト）

### 10.2 CI/CD
- GitHubと連携
- mainブランチへのpushで自動デプロイ

### 10.3 デプロイ手順
1. Supabaseプロジェクト作成
2. データベーステーブル作成（マイグレーション実行）
3. 初期データ投入
4. Vercelプロジェクト作成
5. 環境変数設定
6. GitHubリポジトリ連携
7. デプロイ実行

## 11. 運用・保守

### 11.1 データ管理
- Supabase Dashboard経由で直接編集
- CSVインポート/エクスポート機能を活用

### 11.2 モニタリング
- Vercel Analytics（アクセス解析）
- Supabase Dashboard（データベース監視）
- エラーログの確認

## 12. 将来の拡張可能性

### 12.1 想定される機能追加
- 履歴機能（新テーブル追加）
- お気に入り機能（新テーブル追加）
- カテゴリ分類（カラム追加）
- 難易度設定（カラム追加）

### 12.2 スケーラビリティ
- Supabaseの無料枠: 500MBストレージ、50,000リクエスト/月
- 超過時は有料プランへ移行
